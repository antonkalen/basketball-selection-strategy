---
title: "Basketball selection strategy"
output: 
  bookdown::pdf_document2:
    toc: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(knitr.kable.NA = '')

# Load packages
library(targets)
library(dplyr)
library(ggplot2)
library(patchwork)
library(tidyr)
library(kableExtra)
library(forcats)
library(patchwork)
library(glue)

# Load target objects
tar_load(c(params, raw_last_senior_champ, player_data, country_data))

# GGplot theme
theme_set(
  theme_minimal() + 
    theme(
      panel.grid.minor = element_blank(),
      legend.position = 'bottom',
      legend.title = element_blank(),
      plot.margin = margin(0,0,0,0,"pt"),
    )
  )
```

# Results

## Senior debut age

```{r}

last_senior_champ <- raw_last_senior_champ %>% 
  mutate(debut_age = debut_year - birth_year)

senior_debut_summary <- last_senior_champ %>% 
  group_by(gender, played_youth) %>% 
  summarise(
    n = n(),
    median_debut = median(debut_age),
    "debut_{params$debut_age_cut}" := sum(debut_age <= params$debut_age_cut),
    .groups = "drop"
  ) %>% 
  pivot_wider(
    names_from = c(gender, played_youth), 
    values_from = c(n, median_debut, starts_with("debut_")),
    names_glue = "{gender}_{played_youth}_{.value}"
  ) %>% 
  mutate(
    Men_tot_n = Men_0_n + Men_1_n,
    Women_tot_n = Women_0_n + Women_1_n
  ) %>% as.list()

```

In the last three men's championships, a total of `r senior_debut_summary$Men_tot_n` players participated, of which `r senior_debut_summary %>% glue_data("{Men_1_n} ({round(Men_1_n / Men_tot_n * 100)}%)")` had participated in youth championships.
The median senior debut age was `r senior_debut_summary$Men_1_median_debut` for players who had participated in youth championships, and `r senior_debut_summary$Men_0_median_debut` for players who did not play any youth championships (Figure \@ref(fig:debutage)).
Of the players that had participated in youth championships, `r senior_debut_summary %>% glue_data("{Men_1_debut_25} ({round(Men_1_debut_25 / Men_1_n * 100)}%)")` had debuted at age `r params$debut_age_cut`.

In the last three women's championships, a total of `r senior_debut_summary$Women_tot_n` players participated, of which `r senior_debut_summary %>% glue_data("{Women_1_n} ({round(Women_1_n / Women_tot_n * 100)}%)")` had participated in youth championships.
The median senior debut age was `r senior_debut_summary$Women_1_median_debut` for players who had participated in youth championships, and `r senior_debut_summary$Women_0_median_debut` for players who did not play any youth championships (Figure \@ref(fig:debutage)).
Of the players that had participated in youth championships, `r senior_debut_summary %>% glue_data("{Women_1_debut_25} ({round(Women_1_debut_25 / Women_1_n * 100)}%)")` had debuted at age `r params$debut_age_cut`.

```{r debutage, fig.cap="Debut in senior championships by age. Dashed line indicates median debut age", out.width="70%"}

senior_debut <- last_senior_champ %>% 
  mutate(played_youth = if_else(played_youth == 1, "Played youth", "Senior only"))

senior_debut_median <- senior_debut %>% 
  group_by(gender, played_youth) %>% 
  summarise(debut_age = median(debut_age))
  
plot_1 <- senior_debut %>% 
  ggplot(aes(x = debut_age, color = played_youth, fill = played_youth)) +
    geom_histogram(binwidth = 1, alpha = .5, position = "identity") +
    geom_vline(
      data = senior_debut_median, 
      mapping = aes(xintercept = debut_age, color = played_youth),
      linetype = "dashed",
      show.legend = FALSE
    ) +
    facet_wrap(~gender) +
    coord_cartesian(xlim = c(14.5, 35.5), expand = FALSE) +
    scale_color_brewer(palette = "Dark2") +
    scale_fill_brewer(palette = "Dark2") +
    labs(title = NULL, x = NULL, y = NULL) +
    theme(
      panel.grid.major.x = element_blank(),
      plot.margin = margin(0,0,0,0,"pt"),
      axis.ticks.length.x = unit(2,"pt"),
      axis.ticks.x = element_line(colour = "gray30")
    )

plot_1
```

## Country level data

```{r}
# Make summary table
country_summary <- country_data %>% 
  group_by(gender, country) %>% 
  summarise(
    nr_generations = n(),
    players_mean = weighted.mean(nr_youth_total, nr_youth_total),
    players_cv = sd(nr_youth_total) / mean(nr_youth_total),
    prop_youth_senior = sum(nr_youth_senior) / sum(nr_youth_total),
    senior_ranking = unique(senior_ranking_points),
    youth_ranking = unique(youth_ranking_points),
    ranking_ratio = unique(ranking_points_ratio),
    .groups = "drop"
  ) %>% 
  filter(nr_generations >= params$min_generations)
```




## Number of youth players

The number of included generations, mean and CV for number of youth players per generations, number of youth players who have debuted in seniors, and country ranking points are presented in Table \@ref(tab:desc-table-men) for men, and \@ref(tab:desc-table-women) for women.

```{r desc-table-men}
country_summary %>% 
  filter(gender == "Men") %>% 
  select(-gender) %>% 
  group_by(country) %>% 
  kable(
    caption = "Descriptive statistics of men's countries.",
    booktabs = TRUE,
    linesep = "",
    digits = 2,
    col.names = c("Country", "N", "Mean", "CV", "% Senior", "Senior rank", "Youth rank", "Rank ratio")
  ) %>% 
  kable_styling(font_size = 8) %>% 
  add_footnote("N = Number of generations included; CV = Coefficient of variation; % Senior = Proportion of youth players from included generations who have debuted in senior national team; Senior rank = Normalized (0-1) senior ranking points of the country, Youth rank = Normalized (0-1) youth ranking points of the country", notation = "none")
```

```{r desc-table-women}
country_summary %>% 
  filter(gender == "Men") %>% 
  select(-gender) %>% 
  group_by(country) %>% 
  kable(
    caption = "Descriptive statistics of men's countries.",
    booktabs = TRUE,
    linesep = "",
    digits = 2,
    col.names = c("Country", "N", "Mean", "CV", "% Senior", "Senior rank", "Youth rank", "Rank ratio")
  ) %>% 
  kable_styling(font_size = 8) %>% 
  add_footnote("N = Number of generations included; CV = Coefficient of variation; % Senior = Proportion of youth players from included generations who have debuted in senior national team; Senior rank = Normalized (0-1) senior ranking points of the country, Youth rank = Normalized (0-1) youth ranking points of the country", notation = "none")
```
